#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running basic pre-commit checks..."

# Check for SKIP_HOOKS environment variable
if [ "$SKIP_HOOKS" = "1" ] || [ "$SKIP_HOOKS" = "true" ]; then
    echo "‚ö†Ô∏è  SKIP_HOOKS is set. Bypassing all pre-commit checks..."
    echo "‚ö†Ô∏è  Remember to run linting manually later!"
    exit 0
fi

# Check for merge conflicts
echo "üîç Checking for merge conflicts..."
if git diff --cached --name-only | xargs grep -l '<<<<<<<\|=======' 2>/dev/null | grep -q .; then
    echo "‚ùå Merge conflict markers detected! Please resolve before committing."
    exit 1
fi

# Check for .env files
echo "üîç Checking for .env files..."
if git diff --cached --name-only | grep -E '\.env$' | grep -v '\.env\.example$'; then
    echo "‚ùå .env files must not be committed!"
    exit 1
fi

# Run Node.js linting where possible
echo "üé® Running Node.js project checks..."
for dir in web-gui-node installer; do
    if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
        cd "$dir"
        echo "üìù Checking $dir..."
        npm run lint:fix-safe 2>/dev/null || echo "‚ö†Ô∏è  Linting not available for $dir"
        cd ..
    fi
done

echo "‚úÖ Basic pre-commit checks completed!"
echo "üí° Use SKIP_HOOKS=1 to bypass all checks if needed"
