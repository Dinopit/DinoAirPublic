# DinoAI Table Setup Guide with Row Level Security

This guide provides step-by-step instructions for setting up the DinoAI main memory table in Supabase with proper Row Level Security (RLS) policies.

## Overview

The DinoAI table serves as the main memory database for the DinoAir application. It's a simple table that stores records with auto-incrementing IDs and timestamps.

## Table Structure

```sql
CREATE TABLE IF NOT EXISTS public."DinoAI" (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT "DinoAI_pkey" PRIMARY KEY (id)
) TABLESPACE pg_default;
```

## Step-by-Step Setup

### Step 1: Create the DinoAI Table

1. Open your Supabase project dashboard
2. Navigate to the **SQL Editor**
3. Execute the following SQL command:

```sql
-- Create the DinoAI main memory table
CREATE TABLE IF NOT EXISTS public."DinoAI" (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT "DinoAI_pkey" PRIMARY KEY (id)
) TABLESPACE pg_default;
```

### Step 2: Create Indexes for Performance

```sql
-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS "idx_DinoAI_created_at" ON public."DinoAI"(created_at);
CREATE INDEX IF NOT EXISTS "idx_DinoAI_id" ON public."DinoAI"(id);
```

### Step 3: Set Up Row Level Security (RLS) Policies

#### Enable RLS on the Table

```sql
-- Enable Row Level Security
ALTER TABLE public."DinoAI" ENABLE ROW LEVEL SECURITY;
```

#### Create Security Policies

Choose one of the following policy configurations based on your security requirements:

#### Option A: Open Access (Recommended for Development)

```sql
-- Policy: Allow all authenticated users to read from DinoAI
CREATE POLICY IF NOT EXISTS "Allow authenticated read access" ON public."DinoAI"
  FOR SELECT USING (auth.role() = 'authenticated' OR auth.role() = 'anon');

-- Policy: Allow all authenticated users to insert into DinoAI
CREATE POLICY IF NOT EXISTS "Allow authenticated insert access" ON public."DinoAI"
  FOR INSERT WITH CHECK (auth.role() = 'authenticated' OR auth.role() = 'anon');

-- Policy: Service role can access all DinoAI records
CREATE POLICY IF NOT EXISTS "Service role can access all DinoAI" ON public."DinoAI"
  FOR ALL USING (auth.role() = 'service_role');
```

#### Option B: Authenticated Users Only (More Secure)

```sql
-- Policy: Only authenticated users can read
CREATE POLICY IF NOT EXISTS "Authenticated users can read" ON public."DinoAI"
  FOR SELECT USING (auth.role() = 'authenticated');

-- Policy: Only authenticated users can insert
CREATE POLICY IF NOT EXISTS "Authenticated users can insert" ON public."DinoAI"
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

-- Policy: Service role can access all DinoAI records
CREATE POLICY IF NOT EXISTS "Service role full access" ON public."DinoAI"
  FOR ALL USING (auth.role() = 'service_role');
```

#### Option C: Service Role Only (Most Secure)

```sql
-- Policy: Only service role can access DinoAI
CREATE POLICY IF NOT EXISTS "Service role only access" ON public."DinoAI"
  FOR ALL USING (auth.role() = 'service_role');
```

## Complete Setup Script

Here's the complete SQL script to set up everything at once:

```sql
-- Step 1: Create the DinoAI table
CREATE TABLE IF NOT EXISTS public."DinoAI" (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT "DinoAI_pkey" PRIMARY KEY (id)
) TABLESPACE pg_default;

-- Step 2: Create indexes
CREATE INDEX IF NOT EXISTS "idx_DinoAI_created_at" ON public."DinoAI"(created_at);
CREATE INDEX IF NOT EXISTS "idx_DinoAI_id" ON public."DinoAI"(id);

-- Step 3: Enable RLS
ALTER TABLE public."DinoAI" ENABLE ROW LEVEL SECURITY;

-- Step 4: Create policies (choose Option A, B, or C from above)
-- Option A: Open Access (Development)
CREATE POLICY IF NOT EXISTS "Allow authenticated read access" ON public."DinoAI"
  FOR SELECT USING (auth.role() = 'authenticated' OR auth.role() = 'anon');

CREATE POLICY IF NOT EXISTS "Allow authenticated insert access" ON public."DinoAI"
  FOR INSERT WITH CHECK (auth.role() = 'authenticated' OR auth.role() = 'anon');

CREATE POLICY IF NOT EXISTS "Service role can access all DinoAI" ON public."DinoAI"
  FOR ALL USING (auth.role() = 'service_role');
```

## Verification

After running the setup, verify that everything is working correctly:

### 1. Check Table Creation

```sql
-- Verify the table exists
SELECT table_name, table_schema 
FROM information_schema.tables 
WHERE table_name = 'DinoAI';
```

### 2. Check RLS Status

```sql
-- Verify RLS is enabled
SELECT schemaname, tablename, rowsecurity 
FROM pg_tables 
WHERE tablename = 'DinoAI';
```

### 3. Check Policies

```sql
-- List all policies for the DinoAI table
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual 
FROM pg_policies 
WHERE tablename = 'DinoAI';
```

### 4. Test Basic Operations

```sql
-- Test insert (should work with proper permissions)
INSERT INTO public."DinoAI" DEFAULT VALUES;

-- Test select (should work with proper permissions)
SELECT * FROM public."DinoAI" LIMIT 5;

-- Check record count
SELECT COUNT(*) FROM public."DinoAI";
```

## Troubleshooting

### Common Issues

#### 1. Permission Denied Errors

**Error:** `permission denied for table DinoAI`

**Solution:** 
- Check that RLS policies are correctly configured
- Verify you're using the correct API key (service role key for admin operations)
- Ensure the user has the appropriate role

#### 2. Table Not Found

**Error:** `relation "public.DinoAI" does not exist`

**Solution:**
- Verify the table was created successfully
- Check the exact table name (case-sensitive)
- Ensure you're connected to the correct database

#### 3. RLS Blocking Access

**Error:** `new row violates row-level security policy`

**Solution:**
- Review your RLS policies
- Consider temporarily disabling RLS for testing: `ALTER TABLE public."DinoAI" DISABLE ROW LEVEL SECURITY;`
- Check authentication status and user roles

### Debug Commands

```sql
-- Disable RLS temporarily for testing
ALTER TABLE public."DinoAI" DISABLE ROW LEVEL SECURITY;

-- Re-enable RLS
ALTER TABLE public."DinoAI" ENABLE ROW LEVEL SECURITY;

-- Drop all policies (use with caution)
DROP POLICY IF EXISTS "Allow authenticated read access" ON public."DinoAI";
DROP POLICY IF EXISTS "Allow authenticated insert access" ON public."DinoAI";
DROP POLICY IF EXISTS "Service role can access all DinoAI" ON public."DinoAI";
```

## Integration with DinoAir Application

Once the table is set up, the DinoAir application will automatically use it through the Supabase integration. The application uses:

- **Anonymous Key** for public operations
- **Service Role Key** for admin operations
- **Authenticated sessions** for user-specific operations

## Security Best Practices

1. **Use appropriate policies** based on your security requirements
2. **Test policies thoroughly** before deploying to production
3. **Monitor access logs** in the Supabase dashboard
4. **Regularly review and update policies** as needed
5. **Use service role key sparingly** and only for admin operations

## Next Steps

After setting up the DinoAI table:

1. Test the connection using: `npm run db:test`
2. Run CRUD operation tests: `npm run test:crud`
3. Monitor the table in the Supabase dashboard
4. Set up any additional tables needed for your application

---

*Last updated: 2025-07-25*
*For support, refer to the main Supabase integration documentation.*