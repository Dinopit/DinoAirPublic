# DinoAir Database Setup Guide

This guide explains how to set up the Supabase database for DinoAir's session storage and artifacts management.

## Prerequisites

1. **Supabase Account**: Create a free account at [supabase.com](https://supabase.com)
2. **Node.js**: Version 18.0.0 or higher
3. **Environment Variables**: Properly configured `.env` file

## Environment Configuration

Copy `.env.example` to `.env` and fill in your Supabase credentials:

```bash
cp .env.example .env
```

Update the following variables in your `.env` file:

```env
# Supabase Configuration
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_ANON_KEY=your-anon-key-here
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
DATABASE_URL=postgresql://postgres:your-password@db.your-project-id.supabase.co:5432/postgres
```

## Database Schema Setup

### Option 1: Manual Setup (Recommended)

1. Go to your Supabase project dashboard
2. Navigate to the SQL Editor
3. Execute the following SQL statements in order:

#### 1. Create DinoAI Main Memory Table

```sql
CREATE TABLE IF NOT EXISTS public."DinoAI" (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT "DinoAI_pkey" PRIMARY KEY (id)
) TABLESPACE pg_default;

CREATE INDEX IF NOT EXISTS "idx_DinoAI_created_at" ON public."DinoAI"(created_at);
CREATE INDEX IF NOT EXISTS "idx_DinoAI_id" ON public."DinoAI"(id);
```

#### 2. Create Chat Sessions Table

```sql
CREATE TABLE IF NOT EXISTS chat_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'::jsonb,
  CONSTRAINT chat_sessions_user_id_check CHECK (char_length(user_id) > 0)
);

CREATE INDEX IF NOT EXISTS idx_chat_sessions_user_id ON chat_sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_chat_sessions_created_at ON chat_sessions(created_at);
CREATE INDEX IF NOT EXISTS idx_chat_sessions_updated_at ON chat_sessions(updated_at);
```

#### 3. Create Chat Messages Table

```sql
CREATE TABLE IF NOT EXISTS chat_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'::jsonb,
  CONSTRAINT chat_messages_content_check CHECK (char_length(content) > 0)
);

CREATE INDEX IF NOT EXISTS idx_chat_messages_session_id ON chat_messages(session_id);
CREATE INDEX IF NOT EXISTS idx_chat_messages_created_at ON chat_messages(created_at);
CREATE INDEX IF NOT EXISTS idx_chat_messages_role ON chat_messages(role);

-- Add foreign key constraint
ALTER TABLE chat_messages 
ADD CONSTRAINT IF NOT EXISTS fk_chat_messages_session_id 
FOREIGN KEY (session_id) REFERENCES chat_sessions(id) ON DELETE CASCADE;
```

#### 4. Create Chat Metrics Table

```sql
CREATE TABLE IF NOT EXISTS chat_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL,
  model TEXT NOT NULL,
  response_time_ms INTEGER NOT NULL CHECK (response_time_ms >= 0),
  token_count INTEGER NOT NULL CHECK (token_count >= 0),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'::jsonb,
  CONSTRAINT chat_metrics_model_check CHECK (char_length(model) > 0)
);

CREATE INDEX IF NOT EXISTS idx_chat_metrics_session_id ON chat_metrics(session_id);
CREATE INDEX IF NOT EXISTS idx_chat_metrics_created_at ON chat_metrics(created_at);
CREATE INDEX IF NOT EXISTS idx_chat_metrics_model ON chat_metrics(model);

-- Add foreign key constraint
ALTER TABLE chat_metrics 
ADD CONSTRAINT IF NOT EXISTS fk_chat_metrics_session_id 
FOREIGN KEY (session_id) REFERENCES chat_sessions(id) ON DELETE CASCADE;
```

#### 5. Create Artifacts Table

```sql
CREATE TABLE IF NOT EXISTS artifacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  type TEXT NOT NULL,
  content TEXT NOT NULL,
  size INTEGER NOT NULL CHECK (size >= 0),
  user_id TEXT,
  version INTEGER NOT NULL DEFAULT 1 CHECK (version > 0),
  parent_id UUID,
  tags TEXT[] DEFAULT '{}',
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT artifacts_name_check CHECK (char_length(name) > 0),
  CONSTRAINT artifacts_type_check CHECK (char_length(type) > 0),
  CONSTRAINT artifacts_content_check CHECK (char_length(content) > 0)
);

CREATE INDEX IF NOT EXISTS idx_artifacts_user_id ON artifacts(user_id);
CREATE INDEX IF NOT EXISTS idx_artifacts_created_at ON artifacts(created_at);
CREATE INDEX IF NOT EXISTS idx_artifacts_updated_at ON artifacts(updated_at);
CREATE INDEX IF NOT EXISTS idx_artifacts_type ON artifacts(type);
CREATE INDEX IF NOT EXISTS idx_artifacts_name ON artifacts(name);
CREATE INDEX IF NOT EXISTS idx_artifacts_parent_id ON artifacts(parent_id);
CREATE INDEX IF NOT EXISTS idx_artifacts_version ON artifacts(version);
CREATE INDEX IF NOT EXISTS idx_artifacts_tags ON artifacts USING GIN(tags);
CREATE INDEX IF NOT EXISTS idx_artifacts_metadata ON artifacts USING GIN(metadata);

-- Add foreign key constraint for versioning
ALTER TABLE artifacts 
ADD CONSTRAINT IF NOT EXISTS fk_artifacts_parent_id 
FOREIGN KEY (parent_id) REFERENCES artifacts(id) ON DELETE SET NULL;
```

### Option 2: Automated Setup (Alternative)

If you prefer to use the automated setup script:

```bash
npm run db:setup
```

**Note**: The automated script may require additional configuration depending on your Supabase setup.

## Row Level Security (RLS)

For production deployments, consider enabling Row Level Security:

### Enable RLS for Chat Sessions
```sql
ALTER TABLE chat_sessions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can access own sessions" ON chat_sessions
  FOR ALL USING (auth.uid()::text = user_id);

CREATE POLICY "Service role can access all sessions" ON chat_sessions
  FOR ALL USING (auth.role() = 'service_role');
```

### Enable RLS for Artifacts
```sql
ALTER TABLE artifacts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can access own artifacts" ON artifacts
  FOR ALL USING (user_id IS NULL OR user_id = auth.uid()::text);

CREATE POLICY "Anonymous can access public artifacts" ON artifacts
  FOR SELECT USING (user_id IS NULL);

CREATE POLICY "Service role can access all artifacts" ON artifacts
  FOR ALL USING (auth.role() = 'service_role');
```

## Testing the Setup

After setting up the database, test the connection:

```bash
npm run db:test
```

Test the artifacts migration:

```bash
node scripts/test-artifacts-migration.js
```

## Troubleshooting

### Common Issues

1. **Connection Errors**: Verify your Supabase URL and keys are correct
2. **Permission Errors**: Ensure your service role key has the necessary permissions
3. **Table Creation Errors**: Check that your Supabase project has sufficient resources

### Verification Steps

1. Check that all tables exist in your Supabase dashboard
2. Verify that indexes are created properly
3. Test basic CRUD operations using the Supabase SQL editor

## Migration from In-Memory Storage

The artifacts API has been migrated from in-memory LRU cache to Supabase database storage:

### Key Changes
- ✅ **Database Schema**: Complete artifacts table with versioning support
- ✅ **CRUD Operations**: Full create, read, update, delete functionality
- ✅ **Versioning System**: Support for artifact versions with parent-child relationships
- ✅ **Search & Filtering**: Advanced search by name, content, type, and tags
- ✅ **Statistics**: Real-time storage statistics and utilization tracking
- ✅ **Bulk Operations**: Import/export functionality for multiple artifacts

### Benefits
- **Persistence**: Data survives server restarts
- **Scalability**: No memory limitations
- **Versioning**: Track changes over time
- **Search**: Advanced querying capabilities
- **Multi-user**: Support for user-specific artifacts

## Next Steps

1. Set up user authentication for session management
2. Implement JWT token management with refresh tokens
3. Add database connection pooling and error handling
4. Configure backup and recovery procedures

For more information, see the [API Documentation](./API_DOCUMENTATION.md).